<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
		<title>Coder Page</title>
		<script
			src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAShQlzoLY1aDSYrVpEMEnJRT2yXp_ZAY8_ufC3CFXhHIE1NvwkxS8wjWICSERGwGNr_coXMUf-xCCyw"
			type="text/javascript"></script>
		<script type='text/javascript'>
	var urlstring = document.location.href;
	var indexStart = urlstring.indexOf("param=(");
	var indexEnd = urlstring.indexOf(")", indexStart);
	var urlparam = urlstring.substring(indexStart + 7, indexEnd);
	var urlparams = urlparam.split(",");
	var m_urlBase = urlparams[0];
	var m_search = unescape(urlparams[1]);
	var m_lat = urlparams[2] * 1;
	var m_lng = urlparams[3] * 1;
	var map = null;
	var geocoder = null;
	function load() {
		if (GBrowserIsCompatible()) {
			geocoder = new GClientGeocoder();
			map = new GMap2(document.getElementById("map"));
			map.addControl(new GOverviewMapControl());
			map.enableDoubleClickZoom();
			map.enableScrollWheelZoom();
			map.addControl(new GMapTypeControl());
			map.addControl(new GSmallMapControl());

			if (m_lat != "" && m_lng != "") {
				map.setCenter(new GLatLng(m_lat, m_lng), 13);
			} else if (m_search != "") {
				showAddress(m_search);
			} else {
				map.setCenter(new GLatLng(37.4419, -122.1419), 13);
			}
		}
	}

	function sendCoordinates(lat, lng) {
		var divcomm = document.getElementById("DIVCOMM");
		var divurl = "<iframe src='" + m_urlBase + "/" + lat + "/" + lng
				+ ")' width='500' height='50'>";
		divcomm.innerHTML = divurl;
	}

	function showAddress(address) {
		if (geocoder) {
			geocoder.getLatLng(address, function(point) {
				if (!point) {
					alert(address + " not found");
				} else {
					map.setCenter(point, 17);
					var marker = new GMarker(point, {
						draggable : true
					});
					map.addOverlay(marker);
					marker.openInfoWindowHtml(address);
					sendCoordinates(point.lat(), point.lng());
					GEvent.addListener(marker, "dragend", function() {
						var point = marker.getPoint();
						map.panTo(point);
						sendCoordinates(point.lat(), point.lng());
					});
					GEvent.addListener(map, "moveend", function() {
						map.clearOverlays();
						var center = map.getCenter();
						var marker = new GMarker(center, {
							draggable : true
						});
						map.addOverlay(marker);
						GEvent.addListener(marker, "dragend", function() {
							var point = marker.getPoint();
							map.panTo(point);
							sendCoordinates(point.lat(), point.lng());
						});
					});
				}
			});
		}
	}
</script>
	</head>
	<body onload="load()" onunload="GUnload()">
		<div id="map" style="width: 500px; height: 300px"></div>
		<div style="width: 0px; height: 0px" id="DIVCOMM"></div>
	</body>
</html>
